<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¤ë¬¸ì¡°ì‚¬ ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        /* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 960px;
            margin: 20px;
            display: flex;
            gap: 30px;
        }
        .column {
            flex: 1;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 30px;
        }
        h1, h2 {
            color: #1a1a1a;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"], input[type="number"], select, textarea, input[type="password"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .question-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .question-item button {
            margin-top: 10px;
            background-color: #dc3545;
        }
        .question-item button:hover {
            background-color: #c82333;
        }
        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .survey-item {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: #fff;
        }
        .survey-item h3 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #007bff;
        }
        .survey-actions button {
            margin-right: 10px;
            padding: 8px 15px;
        }
        .survey-actions {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        #admin-content {
            display: none; 
            width: 100%; 
        }
        #login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-bar h1 {
            border-bottom: none;
            padding-bottom: 0;
        }
        #logout-btn {
            background-color: #6c757d;
        }
        #logout-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="login-container">
        <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
        <div id="login-message" class="message" style="display: none;"></div>
        <form id="login-form">
            <label for="username">ì•„ì´ë””:</label>
            <input type="text" id="username" name="username" required><br>
            <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
            <input type="password" id="password" name="password" required><br><br>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div class="container" id="admin-content">
        <div class="column survey-creation">
            <div class="header-bar">
                <h1>ì„¤ë¬¸ì§€ ì œì‘</h1>
                <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="create-message" class="message" style="display: none;"></div>
            <label for="survey-title">ì œëª©:</label>
            <input type="text" id="survey-title" placeholder="ì„¤ë¬¸ì§€ ì œëª©" required>

            <label for="survey-description">ì„¤ëª…:</label>
            <textarea id="survey-description" placeholder="ì„¤ë¬¸ì§€ ì„¤ëª…" required></textarea>

            <h2>ì§ˆë¬¸ ëª©ë¡</h2>
            <div id="questions-list">
                </div>

            <div class="question-item">
                <label for="new-question-text">ìƒˆ ì§ˆë¬¸:</label>
                <input type="text" id="new-question-text" placeholder="ì§ˆë¬¸ ë‚´ìš©">

                <label for="new-question-type">ìœ í˜•:</label>
                <select id="new-question-type">
                    <option value="text">ë‹¨ë‹µí˜•</option>
                    <option value="choice">ê°ê´€ì‹ (ë¼ë””ì˜¤ ë²„íŠ¼)</option>
                    <option value="dropdown">ë“œë¡­ë‹¤ìš´</option> 
                    <option value="rating">ë³„ì  (1-5)</option>
                </select>

                <div id="new-options-container" style="display: none; margin-top: 10px;">
                    <label for="new-question-options">ì˜µì…˜ (ì½¤ë§ˆë¡œ êµ¬ë¶„):</label>
                    <input type="text" id="new-question-options" placeholder="ì˜ˆ: ì˜µì…˜1, ì˜µì…˜2, ì˜µì…˜3">
                </div>
                <button onclick="addQuestion()">ì§ˆë¬¸ ì¶”ê°€</button>
            </div>
            
            <button onclick="createSurvey()">ì„¤ë¬¸ì§€ ì œì‘ ì™„ë£Œ</button>
        </div>

        <div class="column survey-list">
            <h2>ì œì‘ëœ ì„¤ë¬¸ì§€ ëª©ë¡</h2>
            <div id="list-message" class="message" style="display: none;"></div>
            <div id="survey-list">
                </div>
        </div>
    </div>

    <script>
        // ğŸš¨ API ì£¼ì†Œ í™•ì¸: Render ì„œë²„ ì£¼ì†Œë¡œ ì •í™•íˆ ì§€ì •í•´ì£¼ì„¸ìš”.
        const API_URL = 'https://survay.onrender.com/api'; 
        const LOGIN_API_URL = `${API_URL}/login`;

        // -------------------------------------
        // ğŸ’¡ 1. ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜
        // -------------------------------------

        function getAuthHeaders() {
            const token = localStorage.getItem('adminToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` 
            };
        }

        const loginContainer = document.getElementById('login-container');
        const adminContent = document.getElementById('admin-content');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');

        function checkAuthentication() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                loginContainer.style.display = 'none';
                adminContent.style.display = 'flex';
                loadSurveys();
            } else {
                loginContainer.style.display = 'block';
                adminContent.style.display = 'none';
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(LOGIN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    showMessage('login-message', result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                    return;
                }
                
                localStorage.setItem('adminToken', result.token);
                showMessage('login-message', result.message, 'success');
                checkAuthentication();
                
            } catch (error) {
                showMessage('login-message', `ì˜¤ë¥˜: ì„œë²„ì— ì ‘ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
             const logoutBtn = document.getElementById('logout-btn');
             if (logoutBtn) {
                 logoutBtn.addEventListener('click', () => {
                     localStorage.removeItem('adminToken');
                     alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                     checkAuthentication();
                 });
             }
             checkAuthentication(); 
        });


        // -------------------------------------
        // ğŸ’¡ 2. ë©”ì‹œì§€ ë° ì§ˆë¬¸ ìƒì„±/ëª©ë¡ ê¸°ì¡´ í•¨ìˆ˜
        // -------------------------------------

        let questions = [];

        function showMessage(id, message, type) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }

        document.getElementById('new-question-type').addEventListener('change', (e) => {
            const type = e.target.value;
            const optionsContainer = document.getElementById('new-options-container');
            if (type === 'choice' || type === 'dropdown') {
                optionsContainer.style.display = 'block';
            } else {
                optionsContainer.style.display = 'none';
            }
        });

        function renderQuestions() {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = 'question-item';
                let optionsText = '';
                let typeText = '';

                switch(q.type) {
                    case 'text': typeText = 'ë‹¨ë‹µí˜•'; break;
                    case 'choice': typeText = 'ê°ê´€ì‹ (ë¼ë””ì˜¤)'; optionsText = `<br>ì˜µì…˜: ${q.options.join(', ')}`; break;
                    case 'dropdown': typeText = 'ë“œë¡­ë‹¤ìš´'; optionsText = `<br>ì˜µì…˜: ${q.options.join(', ')}`; break;
                    case 'rating': typeText = 'ë³„ì  (1-5)'; break;
                }

                div.innerHTML = `
                    <p><strong>${index + 1}. ${q.text}</strong> (${typeText})${optionsText}</p>
                    <button onclick="removeQuestion(${index})">ì‚­ì œ</button>
                `;
                list.appendChild(div);
            });
        }

        function addQuestion() {
            const text = document.getElementById('new-question-text').value.trim();
            const type = document.getElementById('new-question-type').value;
            const optionsInput = document.getElementById('new-question-options').value.trim();

            if (!text) {
                showMessage('create-message', 'ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let newQuestion = { text, type };
            if (type === 'choice' || type === 'dropdown') {
                if (!optionsInput) {
                     showMessage('create-message', `${type === 'dropdown' ? 'ë“œë¡­ë‹¤ìš´' : 'ê°ê´€ì‹'} ì§ˆë¬¸ì˜ ì˜µì…˜ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'error');
                     return;
                }
                newQuestion.options = optionsInput.split(',').map(o => o.trim()).filter(o => o.length > 0);
                if (newQuestion.options.length === 0) {
                    showMessage('create-message', 'ì˜µì…˜ì„ ì½¤ë§ˆë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
            }

            questions.push(newQuestion);
            renderQuestions();

            document.getElementById('new-question-text').value = '';
            document.getElementById('new-question-options').value = '';
            document.getElementById('new-question-type').value = 'text';
            document.getElementById('new-options-container').style.display = 'none';
            showMessage('create-message', 'ì§ˆë¬¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function removeQuestion(index) {
            questions.splice(index, 1);
            renderQuestions();
            showMessage('create-message', 'ì§ˆë¬¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // -------------------------------------
        // ğŸ’¡ 3. API í†µì‹  í•¨ìˆ˜ (ëª¨ë‘ ì¸ì¦ í—¤ë” ì‚¬ìš©)
        // -------------------------------------

        async function handleAuthError(error) {
             if (error.message.includes('ë¡œê·¸ì¸') || error.message.includes('401')) {
                 alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
                 localStorage.removeItem('adminToken');
                 checkAuthentication();
                 return true; // ì—ëŸ¬ ì²˜ë¦¬í–ˆìŒ
             }
             return false; // ì—ëŸ¬ ì²˜ë¦¬ ì•ˆ í•¨
        }
        
        async function createSurvey() {
            const title = document.getElementById('survey-title').value.trim();
            const description = document.getElementById('survey-description').value.trim();
            
            if (!title || questions.length === 0) {
                showMessage('create-message', 'ì œëª©ì„ ì…ë ¥í•˜ê³  ì§ˆë¬¸ì„ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/surveys`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ title, description, questions })
                });

                const result = await response.json();

                if (!response.ok) { 
                    throw new Error(result.message || response.statusText); 
                }

                document.getElementById('survey-title').value = '';
                document.getElementById('survey-description').value = '';
                questions = [];
                renderQuestions();
                showMessage('create-message', 'ì„¤ë¬¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadSurveys(); 

            } catch (error) {
                if (!await handleAuthError(error)) {
                    showMessage('create-message', `ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            }
        }

        async function loadSurveys() {
            try {
                const response = await fetch(`${API_URL}/surveys`, { 
                    method: 'GET',
                    headers: getAuthHeaders() 
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || response.statusText); 
                }

                const surveys = await response.json();
                const listContainer = document.getElementById('survey-list');
                listContainer.innerHTML = '';
                
                surveys.forEach(survey => {
                    const item = document.createElement('div');
                    item.className = 'survey-item';
                    
                    const domain = window.location.origin;
                    const surveyUrl = `${domain}/${survey._id}`; 
                    
                    item.innerHTML = `
                        <h3>${survey.title}</h3>
                        <p>ì œì‘ì¼: ${new Date(survey.createdAt).toLocaleDateString('ko-KR')}</p>
                        <p>ì§ˆë¬¸ ìˆ˜: ${survey.questions.length}ê°œ</p>
                        <p>ë§í¬: <a href="${surveyUrl}" target="_blank">${surveyUrl}</a></p>
                        <div class="survey-actions">
                            <button onclick="copyLink('${surveyUrl}')">ë§í¬ ë³µì‚¬</button>
                            <button onclick="exportSurvey('${survey._id}', '${survey.title}')">ì—‘ì…€/í…”ë ˆê·¸ë¨ ì „ì†¡</button>
                            <button onclick="deleteSurvey('${survey._id}', '${survey.title}')">ì‚­ì œ</button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });

            } catch (error) {
                if (!await handleAuthError(error)) {
                    showMessage('list-message', `ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            }
        }

        async function deleteSurvey(surveyId, surveyTitle) {
            if (!confirm(`[${surveyTitle}]\n\nì´ ì„¤ë¬¸ì§€ë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê´€ë ¨ ì‘ë‹µë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/surveys/${surveyId}`, { 
                    method: 'DELETE',
                    headers: getAuthHeaders() 
                });
                const result = await response.json();
                
                if (!response.ok) { throw new Error(result.message || response.statusText); }

                showMessage('list-message', result.message, 'success');
                loadSurveys(); 

            } catch (error) {
                 if (!await handleAuthError(error)) {
                    showMessage('list-message', `ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            }
        }

        async function exportSurvey(surveyId, surveyTitle) {
            if (!confirm(`[${surveyTitle}]\n\nì—‘ì…€ ë¦¬í¬íŠ¸ë¥¼ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            try {
                // ğŸš¨ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹œë„
                const response = await fetch(`${API_URL}/surveys/${surveyId}/export`, {
                    method: 'GET',
                    headers: getAuthHeaders() 
                });
                
                const result = await response.json();
                if (!response.ok) {
                     // 500 ì—ëŸ¬ ì‹œ ì„œë²„ì—ì„œ ë³´ë‚¸ ë””í…Œì¼í•œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                     throw new Error(result.details || result.message || response.statusText);
                }
                
                showMessage('list-message', result.message, 'success');

            } catch (error) {
                if (!await handleAuthError(error)) {
                    showMessage('list-message', `ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            }
        }
        
        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('ì„¤ë¬¸ì§€ ì£¼ì†Œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”: ' + url);
            });
        }
    </script>
</body>
</html>